# Convex Setup (alongside Postgres + Prisma)

This project keeps your existing Postgres/Prisma backend intact and adds Convex as an additional real‑time, serverless backend you can deploy to the Convex Cloud for testing.

## What we added

- `convex/schema.ts`: Minimal schema (empty for now) you can extend with tables later.
- `convex/hello.ts`: A sample query to verify the connection.
- `convex/auth.ts`: whoami + syncUser (mirrors Clerk user into Convex DB).
- `convex/presence.ts`: heartbeat + onlineUsers for real-time presence.
- `convex/conversations.ts`: basic conversations and messages APIs.
- `convex/posts.ts`: basic community posts and reactions APIs.
- App integration: The Expo root is wrapped with `ConvexProviderWithClerk` when `EXPO_PUBLIC_CONVEX_URL` is set. If not set, nothing changes at runtime.
- Dependencies: `convex`, `react-native-get-random-values`, `react-native-url-polyfill`.

## Prerequisites

- Node 18+
- An account on https://dashboard.convex.dev
- You’re signed in via the CLI

```powershell
npx convex login
```

## Initialize Convex (first time)

From the repository root:

```powershell
# Install dependencies
npm install

# Initialize a Convex project (creates convex.json if missing)
npx convex init

# Start the local dev server and generate types
npx convex dev
```

During `init` you’ll select or create a Convex project. This will create `convex.json` locally.

## Get your Convex deployment URL

Once a project is created (or after `npx convex dev`), you’ll see a deployment URL, e.g.:

```
https://nice-salad-123.convex.cloud
```

Expose it to the app via Expo’s public env var:

- For local dev, you can create a `.env` file with:
  
  ```env
  EXPO_PUBLIC_CONVEX_URL="https://<your-project>.convex.cloud"
  ```

- For EAS builds or previews, set `EXPO_PUBLIC_CONVEX_URL` in your EAS/Expo environment.

The app conditionally enables Convex only when this variable is present.

## Deploy to Convex Cloud

```powershell
npx convex deploy
```

This publishes your functions (e.g., `convex/hello.ts`) to your Convex production environment.

## Quick client test

Anywhere in your app you can test the sample query once the provider is active:

```tsx
import { useQuery } from "convex/react";
// Adjust the relative path based on your file location, this file is generated by `npx convex dev`:
import { api } from "../../convex/_generated/api";

export function HelloFromConvex() {
  const message = useQuery(api.hello.greet, { name: "SafeSpace" }) ?? "…";
  return <Text>{message}</Text>;
}
```

Note: The `api` import is generated after you run `npx convex dev`. If you haven’t run it yet, this import won’t resolve.

## Feature flags / migration strategy

This project keeps Postgres/Prisma as the source of truth. Convex is introduced gradually for real-time features:

- **Auth**: All auth screens (login, signup, reset-password) now sync users to Convex via `utils/convexAuthSync.ts` after successful Clerk authentication. Sync is non-blocking - if Convex fails, the user can still proceed.
- **Presence**: `presence.heartbeat` updates user status every 5 minutes. Initial heartbeat sent after login/signup. UI can optionally consume `presence.onlineUsers`.
- **Home Tab**: 
  - Recent moods load from `moods.getRecentMoods`
  - Mood stats use `moods.getMoodStats`
  - Activity tracking via `activities.recordActivity`
  - Falls back to REST API if Convex unavailable
- **Community Forum**: 
  - Trending feed uses `posts.list` from Convex
  - My Posts uses `posts.myPosts` with draft filtering
  - Reactions use `posts.react` and `posts.listReactions`
  - Categories and bookmarks still use REST (migration pending)
- **Appointments Tab**: 
  - Schema and functions ready (`appointments.*`)
  - Integration pending - will use `getAppointmentStats`, `getUserAppointments`
  - Real-time appointment updates and status changes
- **Messages Tab**: 
  - Schema and functions ready (`conversations.*`, `messages.*`)
  - Integration pending - will use real-time subscriptions
  - Presence indicators for online users
- **Profile Tab**: 
  - Schema and functions ready (`profiles.*`)
  - Integration pending - will sync profile updates to Convex
  - Real-time preference changes

To adopt per-screen, prefer reading from Convex first (if enabled) and fall back to existing REST endpoints. Writes can be dual-written temporarily (to Postgres and Convex) during migration. Use dynamic imports of `convex/_generated/api` to avoid build errors before generation.

See `CONVEX-TABS-INTEGRATION.md` for detailed integration guide for all tabs.

## Auth Integration

All authentication screens now include Convex synchronization:

**Login** (`app/(auth)/login.tsx`):
- After successful Clerk sign-in, calls `completeConvexAuthFlow()`
- Syncs user profile to Convex
- Sends initial presence heartbeat
- Non-blocking: user proceeds to app even if Convex sync fails

**Signup** (`app/(auth)/signup.tsx`):
- After email verification, calls `completeConvexAuthFlow()`
- Creates user in Convex with profile data
- Sends initial presence heartbeat

**Reset Password** (`app/(auth)/reset-password.tsx`):
- After successful password reset, sends presence heartbeat
- Marks user as online in Convex

**Forgot Password** (`app/(auth)/forgot-password.tsx`):
- No Convex changes needed (uses Clerk password reset email flow)

All sync operations use the `utils/convexAuthSync.ts` utility for consistent behavior.

## Using Clerk auth with Convex

The app wraps the tree with `ConvexProviderWithClerk`, passing Clerk’s `useAuth`. Convex functions can read `ctx.auth` for the user’s identity. Configure Convex Auth in your project settings if you need server-side auth enforcement.

## Keeping Postgres/Prisma

No existing code was removed or changed beyond a safe provider wrapper and polyfills. Your Postgres/Prisma backend continues to work as-is. You can migrate features gradually to Convex or use it for specific real-time workflows.

## Troubleshooting

- If you see crypto/URL related errors in React Native, ensure the polyfills were installed and imported (already added in `app/_layout.tsx`).
- If `EXPO_PUBLIC_CONVEX_URL` isn’t set, Convex is simply disabled and your app behaves as before.
- If types are missing for `api.*`, make sure you’ve run `npx convex dev` to generate `convex/_generated/*` files.
