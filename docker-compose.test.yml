version: '3.8'

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test
    volumes:
      # Mount source code for live updates during development
      - .:/app
      # Prevent node_modules from being overwritten
      - /app/node_modules
      # Mount test results and coverage
      - ./coverage:/app/coverage
      - ./test-results:/app/test-results
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    # Override default command for different test scenarios
    # Use docker-compose run test npm test -- <args>
    stdin_open: true
    tty: true

  # Service for running tests in watch mode
  test-watch:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-watch
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:watch

  # Service for running tests with coverage
  test-coverage:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-coverage
    volumes:
      - .:/app
      - /app/node_modules
      - ./coverage:/app/coverage
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:coverage
  
  # Feature-specific test runners
  test-announcements:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-announcements
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:announcements

  test-appointments:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-appointments
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:appointments

  test-auth:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-auth
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:auth

  test-community:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-community
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:community

  test-crisis:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-crisis
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:crisis

  test-home:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-home
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:home

  test-journal:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-journal
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:journal

  test-messages:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-messages
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:messages

  test-moods:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-moods
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:moods

  test-profile:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-profile
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:profile

  test-settings:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-settings
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:settings

  test-resources:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-resources
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:resources

  test-self-assessment:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-self-assessment
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:self-assessment

  test-video:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-video
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:video

  test-all-features:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: safespace-test-all-features
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - EXPO_PUBLIC_CONVEX_URL=http://host.docker.internal:1
    command: npm run test:all-features
